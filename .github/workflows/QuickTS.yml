#
# https://github.com/P3TERX/Actions-OpenWrt
#
# File: .github/workflows/openwrt-bulder.yml
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: test-6.6-B70

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/GruntFish/immortalwrt-mtkhnat-6.6
  REPO_BRANCH: openwrt-24.10-6.6
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: configs/test.config
  DIY_P0_SH: scripts/HNAT.sh
  DIY_P1_SH: scripts/2410-diy-part1.sh
  DIY_P2_SH: scripts/2410-diy-part2.sh
  DIY_P3_SH: scripts/2410-diy-part3.sh
  RELEASE_FILE: 6.6-release-note.txt
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

  - name: Check HNAT source existence
      run: |
        echo "ğŸ” æ£€æŸ¥ HNAT æºç æ˜¯å¦å­˜åœ¨..."
        
        # æ£€æŸ¥å†…æ ¸é©±åŠ¨æºç 
        echo "=== å†…æ ¸é©±åŠ¨æºç æ£€æŸ¥ ==="
        if [ -d "target/linux/mediatek/files-6.6/drivers/net/ethernet/mediatek/mtk_hnat" ]; then
          echo "âœ… æ‰¾åˆ° HNAT å†…æ ¸é©±åŠ¨æºç "
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la target/linux/mediatek/files-6.6/drivers/net/ethernet/mediatek/mtk_hnat/
        else
          echo "âŒ æœªæ‰¾åˆ° HNAT å†…æ ¸é©±åŠ¨æºç "
          echo "æœç´¢æ‰€æœ‰ hnat ç›¸å…³æ–‡ä»¶:"
          find . -name "*hnat*" -type f | head -10
        fi
        
        # æ£€æŸ¥æ¨¡å—å®šä¹‰
        echo "=== æ¨¡å—å®šä¹‰æ£€æŸ¥ ==="
        if [ -f "target/linux/ramips/modules.mk" ]; then
          echo "âœ… æ‰¾åˆ°æ¨¡å—å®šä¹‰æ–‡ä»¶"
          grep -A5 "mtk-hnat" target/linux/ramips/modules.mk || echo "æœªæ‰¾åˆ° mtk-hnat å®šä¹‰"
        fi
        
    - name: Configure for HNAT
      run: |
        echo "ğŸ”§ é…ç½® HNAT æ”¯æŒ..."
        
        # ä½¿ç”¨ MT7621 é…ç½®
        cp target/linux/ramips/mt7621/config-6.6 .config
        
        # ç¡®ä¿ HNAT é…ç½®ä¸ºæ¨¡å—
        if ! grep -q "CONFIG_NET_MEDIATEK_HNAT=m" .config; then
          echo "CONFIG_NET_MEDIATEK_HNAT=m" >> .config
          echo "âœ… å·²æ·»åŠ  HNAT æ¨¡å—é…ç½®"
        fi
        
        # é€‰æ‹©ç›®æ ‡å¹³å°
        echo "CONFIG_TARGET_ramips=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
        
        echo "ğŸ“‹ HNAT ç›¸å…³é…ç½®:"
        grep -i "mediatek.*hnat" .config
        
    - name: Quick build and detect HNAT
      run: |
        echo "ğŸš€ å¼€å§‹å¿«é€Ÿç¼–è¯‘å¹¶æ£€æµ‹ HNAT æ¨¡å—..."
        
        # å‡†å¤‡å·¥å…·é“¾ï¼ˆé™é»˜æ¨¡å¼ï¼‰
        echo "âš™ï¸ å‡†å¤‡å·¥å…·é“¾..."
        make tools/install -j$(nproc) > /dev/null 2>&1
        make toolchain/install -j$(nproc) > /dev/null 2>&1
        
        # æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘
        rm -rf build_dir/target-*/linux-*/linux-*/drivers/net/ethernet/mediatek/mtk_hnat/
        
        echo "=== å¼€å§‹å†…æ ¸ç¼–è¯‘ï¼Œå®æ—¶ç›‘æ§ HNAT æ¨¡å— ==="
        
        # ç¼–è¯‘å†…æ ¸ï¼ˆåå°è¿è¡Œï¼‰
        make target/linux/compile -j1 V=s 2>&1 | tee /tmp/build.log &
        BUILD_PID=$!
        
        # ç›‘æ§è¿›ç¨‹ - æ‰¾åˆ°HNATå°±ç«‹å³åœæ­¢
        HNAT_FOUND=false
        MAX_WAIT=300  # æœ€å¤šç­‰å¾…5åˆ†é’Ÿ
        
        for i in $(seq 1 $MAX_WAIT); do
          # æ£€æŸ¥ç¼–è¯‘è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if ! kill -0 $BUILD_PID 2>/dev/null; then
            echo "â„¹ï¸ ç¼–è¯‘è¿›ç¨‹å·²ç»“æŸ"
            break
          fi
          
          # æœç´¢ HNAT .ko æ–‡ä»¶
          KO_FILE=$(find . -name "mtkhnat.ko" -type f 2>/dev/null | head -1)
          if [ -z "$KO_FILE" ]; then
            KO_FILE=$(find . -name "hnat.ko" -type f 2>/dev/null | head -1)
          fi
          
          if [ -n "$KO_FILE" ] && [ "$HNAT_FOUND" = "false" ]; then
            echo ""
            echo "ğŸ‰ğŸ‰ğŸ‰ HNAT æ¨¡å—ç¼–è¯‘æˆåŠŸï¼ ğŸ‰ğŸ‰ğŸ‰"
            echo "=========================================="
            echo "ğŸ“ æ–‡ä»¶è·¯å¾„: $KO_FILE"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh "$KO_FILE" | awk '{print $5}')"
            echo "ğŸ” ç»å¯¹è·¯å¾„: $(pwd)/$KO_FILE"
            echo ""
            
            # æ˜¾ç¤ºæ–‡ä»¶è¯¦ç»†ä¿¡æ¯
            echo "ğŸ“‹ æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
            ls -la "$KO_FILE"
            echo ""
            
            # æ˜¾ç¤ºç›®å½•å†…å®¹
            echo "ğŸ“ æ‰€åœ¨ç›®å½•: $(dirname "$KO_FILE")"
            ls -la "$(dirname "$KO_FILE")" | head -5
            echo ""
            
            HNAT_FOUND=true
            
            # ç«‹å³åœæ­¢ç¼–è¯‘è¿›ç¨‹
            echo "ğŸ›‘ æ£€æµ‹åˆ°HNATæ¨¡å—ï¼Œç«‹å³åœæ­¢ç¼–è¯‘..."
            kill $BUILD_PID 2>/dev/null
            break
          fi
          
          # æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ä¸­çš„HNATæ´»åŠ¨
          if tail -n 10 /tmp/build.log | grep -q "hnat\.c\|mtk_hnat"; then
            echo "ğŸ“ HNATç¼–è¯‘ä¸­: $(tail -n 10 /tmp/build.log | grep 'hnat\.c\|mtk_hnat' | tail -1)"
          fi
          
          sleep 3
        done
        
        if [ "$HNAT_FOUND" = "false" ]; then
          echo ""
          echo "âŒ è¶…æ—¶æœªæ‰¾åˆ° HNAT æ¨¡å—"
          echo "=========================================="
          
          # åœæ­¢ç¼–è¯‘è¿›ç¨‹
          kill $BUILD_PID 2>/dev/null
          
          # é”™è¯¯åˆ†æ
          echo "ğŸ” é”™è¯¯åˆ†æ:"
          grep -i "error" /tmp/build.log | grep -i "hnat\|mtk_hnat" | head -5 || echo "æœªæ‰¾åˆ°HNATç›¸å…³ç¼–è¯‘é”™è¯¯"
          
          echo "ğŸ“‹ HNATç›¸å…³æ—¥å¿—:"
          grep -i "hnat\|mtk_hnat" /tmp/build.log | tail -10 || echo "æ— HNATç›¸å…³æ—¥å¿—"
        fi
        
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: hnat-build-log
        path: /tmp/build.log
        retention-days: 3
